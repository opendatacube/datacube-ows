name: OWS build and push

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
    types: [synchronize, opened, reopened, ready_for_review]

env:
  ORG: opendatacube
  IMAGE: ows

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Login to DockerHub
      run: |
        echo "${{ secrets.DockerPassword }}" | docker login -u "${{ secrets.DockerUser }}" --password-stdin

    # Build image and tag as latest, connect to pre-indexed database
    - name: Build Docker Containers
      run: docker-compose up --build -d

    # Run some tests on the images
    - name: Test ping
      run: |
        curl --silent --show-error --fail \
        "localhost:8000/ping" \
        > /dev/null

    - name: Test WMS GetCapabilities
      run: |
        curl --silent --show-error --fail \
        "localhost:8000/?service=WMS&version=1.3.0&request=GetCapabilities" \
        > /dev/null

    - name: Test WMTS GetCapabilities
      run: |
        curl --silent --show-error --fail \
        "localhost:8000/?service=WMS&version=1.0.0&request=GetCapabilities" \
        > /dev/null

    - name: Test WCS GetCapabilities
      run: |
        curl --silent --show-error --fail \
        "localhost:8000/?service=WCS&version=1.0.0&request=GetCapabilities" \
        > /dev/null

    - name: Test datacube-ows-update
      run: docker-compose exec datacube-ows-exec

    # Tag image if this is a tagged build
    # if not use a pseudo tag based on current tag,
    # number of commits since last tag and hash
    - name: Push to DockerHub (master branch only)
      if: github.ref == 'refs/heads/master'
      run: |
        tag=$(git describe --tags)
        docker tag ${ORG}/${IMAGE}:latest ${ORG}/${IMAGE}:${tag}
        docker push ${ORG}/${IMAGE}:latest
        docker push ${ORG}/${IMAGE}:${tag}